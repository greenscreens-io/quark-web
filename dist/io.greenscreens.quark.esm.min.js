class Buffer{static#e=new TextEncoder;static#t=new TextDecoder;static validateData(e){let t=null;if(e instanceof Array)t=new Uint8Array(e);else if(e instanceof ArrayBuffer)t=new Uint8Array(e);else if(e instanceof Uint8Array)t=e;else if(e instanceof String||'string'==typeof e)t=Buffer.fromText(e);else{if(!e.toArrayBuffer)throw'Invalid input, must be String or ArrayBuffer or Uint8Array';t=new Uint8Array(e.toArrayBuffer())}return t}static isString(e){return'string'==typeof e}static isHexString(e){return!!Buffer.isString(e)&&/^[0-9A-Fa-f]+$/g.test(e)}static toBuffer(e,t=!1){const n=Buffer;return n.isString(e)&&(e=t?n.fromBase64(e):n.isHexString(e)?n.fromHex(e):n.fromText(e)),n.validateData(e)}static toText(e){return Buffer.isText(e)?e:Buffer.#t.decode(e)}static fromText(e){return Buffer.isText(e)?Buffer.#e.encode(e):e}static isText(e){return'string'==typeof e}static fromHex(e){const t=[];for(let n=0;n<e.length;n+=2)t.push(parseInt('0x'+e.substr(n,2),16));return new Uint8Array(t)}static toHex(e){return Array.prototype.map.call(new Uint8Array(e),(e=>('00'+e.toString(16)).slice(-2))).join('')}static fromBase64(e){const t=atob(e),n=new ArrayBuffer(t.length),r=new Uint8Array(n);for(let e=0,n=t.length;e<n;e++)r[e]=t.charCodeAt(e);return r}static toBase64(e){return e=Buffer.toBuffer(e),btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),''))}}class QuarkEvent extends EventTarget{#n=new Set;#r(e='',t){const n=Array.from(this.#n);return QuarkEvent.#i(t)?n.filter((n=>n.type===e&&n.listener===t)):n.filter((t=>t.type===e))}addEventListener(e,t,n){return!!QuarkEvent.#i(t)&&(this.#n.add({type:e,listener:t}),super.addEventListener(e,t,n))}removeEventListener(e,t){const n=this,r=n.#r(e,t);r.forEach((e=>super.removeEventListener(e.type,e.listener))),r.forEach((e=>n.#n.delete(e)))}unbind(){Array.from(this.#n).forEach((e=>{super.removeEventListener(e.type,e.listener)})),this.#n.clear()}on(e='',t){return this.addEventListener(e,t)}once(e,t){let wrap=e=>{t(e),wrap=null};return wrap.type=e,wrap.listener=t,this.addEventListener(e,wrap,{once:!0})}off(e='',t){return this.removeEventListener(e,t)}emit(e,t){if(!e)return!1;const n=new CustomEvent(e,{detail:t});return this.dispatchEvent(n)}send(e,t){this.emit(e,t)}listen(e,t){this.on(e,t)}unlisten(e,t){this.off(e,t)}wait(t=''){if(!t)return e('Event undefined!');const n=this;return new Promise(((e,r)=>{n.once(t,(t=>e(t)))}))}static#i(e){return'function'==typeof e}static prevent(e){QuarkEvent.#i(e,'preventDefault')&&e.preventDefault(),QuarkEvent.#i(e,'stopPropagation')&&e.stopPropagation()}static{Object.freeze(QuarkEvent)}}class Streams{static get isAvailable(){return'undefined'!=typeof CompressionStream&&'undefined'!=typeof DecompressionStream}static#s(e,t=!1,n=!1){if(!e instanceof Uint8Array)return e;const r=Streams.#a(t,n),i=new Uint8Array(8+e.length),s=new DataView(i.buffer);return s.setUint8(0,71),s.setUint8(1,83),s.setUint8(2,5),s.setUint8(3,r),s.setUint32(4,e.length),i.set(e,8),i}static async wrap(e,t){return e=Streams.toBinary(e),e=await Streams.compressOrDefault(e),e=await t.encrypt(e),e=Streams.#s(e,t.isValid,Streams.isAvailable)}static async unwrap(e,t,n){e instanceof Uint8Array&&(e=e.buffer);const r=new DataView(e),i=Streams.#c(r);if(e=Streams.toBinary(e),!i)return e;const s=r.getUint8(3),a=r.getUint32(4);if(r.byteLength!==a+8)return e;e=e.slice(8);const c=Streams.isCompressFlag(s),o=Streams.isEncryptFlag(s);let u=null;if(Streams.isApiFlag(s)){const i=r.getUint32(8),s=r.getUint32(12+i),a=r.getUint32(12+i+4+s);u={challenge:n,keyEnc:e.slice(4,4+i),keyVer:e.slice(4+i+4,4+i+4+s),signature:e.slice(4+i+4+s+4,4+i+4+s+4+a)},await t.init(u),e=e.slice(12+i+s+a)}if(o&&(e=await(t?.decrypt(e))),c&&(e=await Streams.decompress(e).arrayBuffer()),e=Streams.toBinary(e),!Streams.isJson(e))throw new Error('Invalid response');return JSON.parse(Buffer.toText(e))}static#c(e){return e.byteLength>8&&18259===e.getUint16(0)&&5===e.getUint8(2)}static isCompressFlag(e){return 1==(1&e)}static isEncryptFlag(e){return 2==(2&e)}static isApiFlag(e){return 4==(4&e)}static#a(e,t){return(t?1:0)|(e?2:0)}static#o(e,t){const n=this.toBinary(e),r=t.writable.getWriter();return r.write(n),r.close(),new Response(t.readable)}static async compressOrDefault(e,t='gzip'){if(!Streams.isAvailable)return e;const n=await Streams.compress(e,t).arrayBuffer();return Streams.toBinary(n)}static async decompressOrDefault(e,t='gzip'){if(!Streams.isAvailable)return e;const n=await Streams.decompress(e,t).arrayBuffer();return Streams.toBinary(n)}static compress(e,t='gzip'){const n=new CompressionStream(t);return this.#o(e,n)}static decompress(e,t='gzip'){const n=new DecompressionStream(t);return this.#o(e,n)}static toBinary(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):'string'==typeof e?Buffer.fromText(e):this.toBinary(JSON.stringify(e))}static isCompressed(e){return e=this.toBinary(e),this.isGzip(e)}static isGzip(e){return 31===e.at(0)&&139===e.at(1)&&8===e.at(2)}static isZlib(e){return 120===e.at(0)&&[1,94,156,218].indexOf(e.at(1))>-1}static isJson(e){const t=this,n=(e='string'==typeof e?e.trim():t.toBinary(e)).at(0),r=e.at(e.length-1);return t.#u(n,r)||t.#l(n,r)}static#l(e,t){return!('{'!==e&&123!==e||'}'!==t&&125!==t)}static#u(e,t){return!('['!==e&&91!==e||']'!==t&&93!==t)}}class Security{static#f={name:'ECDH',namedCurve:'P-256'};static#y={name:'ECDSA',namedCurve:'P-384'};static#h={name:'ECDSA',hash:'SHA-384'};static#p={name:'AES-CTR',length:256};#d=null;#g=null;#m=null;static getRandom(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}static initKeyPair(){return crypto.subtle.generateKey(Security.#f,!0,['deriveKey','deriveBits'])}static async importKey(e,t,n){const r=Buffer.toBuffer(e,!0),i=n?n.split(','):[];return crypto.subtle.importKey('spki',r,t,!0,i)}static async exportKey(e){const t=await crypto.subtle.exportKey('raw',e);return Buffer.toHex(t)}static async verify(e,t,n){t=Buffer.toBuffer(t,!0),n=Buffer.toBuffer(n);const r=Security.#h;return crypto.subtle.verify(r,e,t,n)}static async sign(e,t){return t=Buffer.toBuffer(t),crypto.subtle.sign('ECDSA',e,t)}get publicKey(){return this.#d}cookie(e='/'){return`gs-public-key=${this.#d||''};path=${e}`}updateCookie(e='/'){document.cookie=this.cookie(e)}#S(e){return[e.challenge||'',this.#w(e.keyEnc)||'',this.#w(e.keyVer)||''].join('')}#w(e){return Buffer.isText(e)?e:Buffer.toBase64(e)}async#b(e){const t=Security.#y,n=await Security.importKey(e.keyVer,t,'verify');if(!await Security.verify(n,e.signature,this.#S(e)))throw new Error('Signature invalid')}#A(e){return Security.importKey(e.keyEnc,Security.#f,'')}#E(e,t){const n={name:'ECDH',public:t},r=Security.#p;return crypto.subtle.deriveKey(n,e,r,!1,['encrypt','decrypt'])}#C(e){e=Buffer.toBuffer(e);const t=Object.assign({counter:e},Security.#p);return t.length=128,t}async encryptRaw(e,t,n){const r=Buffer.toBuffer(n),i=this.#C(t);return crypto.subtle.encrypt(i,e,r)}async decryptRaw(e,t,n){const r=Buffer.toBuffer(n),i=this.#C(t);return crypto.subtle.decrypt(i,e,r)}async decryptAsBuffer(e,t,n){const r=await this.decryptRaw(e,t,n);return Buffer.toBuffer(r)}async encryptAsBuffer(e,t,n){const r=await this.encryptRaw(e,t,n);return Buffer.toBuffer(r)}async decryptAsString(e,t,n){const r=await this.decryptRaw(e,t,n);return Buffer.toText(r)}async encryptAsHex(e,t,n){const r=await this.encryptRaw(e,t,n);return Buffer.toHex(r)}get isValid(){return null!==this.#d&&null!==this.#m}static get isAvailable(){return!!crypto.subtle}async init(e){if(!Security.isAvailable)return;const t=this;await t.#b(e);const n=await t.#A(e);t.#m=await t.#E(t.#g.privateKey,n),t.#g=null}async encrypt(e){const t=this;if(!t.isValid)return e;if(!e instanceof Uint8Array)return e;const n=Security.getRandom(16),r=await t.encryptAsBuffer(t.#m,n,e),i=new Uint8Array(n.length+r.length);return i.set(n,0),i.set(r,n.length),i}async decrypt(e,t){return t||(t=e.slice(0,16),e=e.slice(16)),await this.decryptAsBuffer(this.#m,t,e)}async#k(){const e=this;e.#g=await Security.initKeyPair(),e.#d=await Security.exportKey(e.#g.publicKey)}static async create(e){const t=new Security;return await t.#k(),e&&await t.init(e),t}}class Queue extends Map{#B=0;#v=0;#x=0;updateRequest(e){const t=this;t.#x++,t.#B++,e.tid=t.#x.toString(),t.set(e.tid,e)}reset(){const e=this;e.#B>50&&e.#v>=e.#B&&(e.#B=0,e.#v=0,e.clear())}process(e){const t=this,n=[];if(Array.isArray(e))e.forEach((e=>{const n=t.execute(e);n&&unkown.push(n)}));else{const r=t.execute(e);r&&n.push(r)}return n}execute(e){const t=this,n=e.tid;let r=null;if(t.#v++,t.has(n)){const r=t.get(n);try{r.finish(e)}catch(e){r.finish(e)}finally{t.delete(n)}}else r=e;return t.reset(),r}}class Request{#P=0;#R=0;#I;constructor(e,t){const n=this;n.#I=t,n.#R=e,n.#U()}get(e,t){const n=this;return'timeout'===t?n.timeout:'finish'===t?n.callback.bind(n):e[t]}callback(e){const t=this;if(!t.timeout)return t.#W(),t.#I(e)}get timeout(){return!0===this.#R}#W(){0!==this.#P&&clearTimeout(this.#P)}#U(){const e=this;0!==e.#R&&(e.#P=setTimeout((()=>{e.#R=!0,e.#I(new Error('Call timeouted!'))}),e.#R))}static wrap(e,t,n){return new Proxy(e,new Request(t,n))}}class Generator extends QuarkEvent{#T={};#P=null;#O=0;#R=0;constructor(e=0,t=0){super(),this.#P=e,this.#R=t}get api(){return this.#T}stop(){const e=this;e.off('call'),e.off('api'),e.off('raw'),e.off('error'),e.#K()}#M(e,t){for(let n in e){let r=e[n];'object'==typeof r?this.#M(r,t)&&(e[n]=null):r._id_===t&&(e[n]=null)}return 0===Object.values(e).filter((e=>null!=e)).length}#K(){const e=this;e.#M(e.#T,e.#P),e.#T={}}build(e){const t=e?e.api||e:null;return t&&this.#D(t),t}#D(e){const t=this;Array.isArray(e)?e.forEach((e=>t.#G(e))):t.#G(e)}#G(e){const t=this;let n=null,r=null;n=t.#q(e.namespace),n[e.action]||(n[e.action]={}),r=n[e.action],t.#_(e.methods)?.forEach((e=>t.#L(r,e,t.#P)))}#_(e){return e.reduce(((e,t,n,r)=>{if(1==e.filter((e=>e.name==t.name)).length)return e;const i=r.filter((e=>e.name==t.name));if(1===i.length)return e.push(t),e;const s=i.filter((e=>e.name===t.name)).reduce(((e,t)=>(e.mid.push(t.mid),e.len.push(t.len),e.async[t.len]=t.async,e)),{name:t.name,mid:[],len:[],async:{}});return e.push(s),e}),[])}#q(e){let t=globalThis,n=this.#T;return e.split('.').every((e=>(t[e]||(t[e]={}),t=t[e],n[e]||(n[e]=t),n=t,!0))),t}#L(e,t,n){const r=!1!==t.encrypt,i={l:t.len,a:t.async||!1,x:t.mid,e:r,i:n};e[t.name]=this.#j(i),e[t.name]._id_=n}#j(e){const t=this,n=e;return function(){const e=Array.prototype.slice.call(arguments),r=Array.isArray(n.l),i=r?n.l.filter((t=>t===e.length)).pop():n.l;if(e.length!=i)throw new Error(`Invalid arguments length. Required (${n.l})`);const s=Array.isArray(n.x)?n.x[i-1]:n.x,a=r?n.a[e.length]:n.a,c=a?0:t.#R,o={handle:s,id:n.i,enc:n.e,data:e,key:++t.#O,tid:0,ts:Date.now()};return Object.seal(o),new Promise(((e,n)=>{try{const r=Request.wrap(o,c,(r=>{t.#J(r,e,n)}));t.emit('call',r)}catch(e){n(e)}}))}}#J(e,t,n){if(e instanceof Error)return n(e);const r=e.result||e;r.success?t(r):n(r)}static build(e,t,n){const r=new Generator(t,n);return r.build(e),r}}class SocketChannel extends QuarkEvent{#F=Date.now();#N=new Queue;#Q=null;#V=null;#H=0;async init(e){const t=this;return t.stop(),t.#V=e,new Promise(((e,n)=>(t.#Y(e,n),null)))}get isOpen(){const e=this;return null!=e.#Q&&e.#Q.readyState===e.#Q.OPEN}stop(){const e=this;return null!=e.#Q&&(e.#Q.close(),e.#Q=null,e.#V=null,!0)}#z(e,t){const n={type:'GS',cmd:e,data:t?[t]:null};return JSON.stringify(n)}get#$(){return this.#z('ping')}async#Z(e){const t=this;if((e=e.detail).id!==t.#V.id)return;t.#N.updateRequest(e);const n=t.#z('data',e),r=await Streams.wrap(n,t.#V.Security);t.#Q.send(r)}async#Y(e,t){const n=this,r=n.#V,i=r.Generator,s=new URL(r.serviceURL),a=Object.assign({},r.querys||{});a.q=n.#F,a.c=Streams.isAvailable,Object.entries(a||{}).forEach((e=>{e[1]&&s.searchParams.append(e[0],encodeURIComponent(e[1]))})),r.Security.updateCookie(),n.#Q=new WebSocket(s.toString(),['quark']),n.#Q.binaryType='arraybuffer';const c=n.#Z.bind(n);n.#Q.onopen=s=>{if(n.emit('online',s),i.on('call',c),n.#X(),!r.isWSAPI)return e(!0);i.once('api',(async i=>{try{const t=i.detail;t.challenge=n.#F,await r.registerAPI(t),e(!0)}catch(i){t(i)}}))},n.#Q.onclose=e=>{i.off('call',c),clearInterval(n.#H),n.stop(),n.emit('offline',e)},n.#Q.onerror=e=>{i.off('call',c),t(e),n.stop(),n.emit('error',e)},n.#Q.onmessage=async e=>{try{e.data instanceof ArrayBuffer?await n.#ee(e.data):await n.#te(e.data)}catch(t){t.data=e,i.emit('error',t)}}}#X(){const e=this;e.#H=setInterval((()=>{e.send(e.#$)}),15e3)}async#ee(e){const t=this,n=t.#V.Security;e=await Streams.unwrap(e,n,t.#F);if(!Streams.isJson(e))return generator.emit('raw',e);Array.isArray(e)?e.forEach((e=>t.#ne(e))):t.#ne(e)}async#te(e){const t=this,n=t.#V.Generator;try{if(!Streams.isJson(e))return n.emit('raw',e);e=JSON.parse(e),Array.isArray(e)?e.forEach((e=>t.#ne(e))):t.#ne(e)}catch(e){n.emit('error',e)}}async#ne(e){const t=this;let n=null;const r=t.#V.Generator;if('api'===e.cmd)return r.emit('api',e.data);if('err'===e.cmd)return r.emit('error',e.result);if('data'===e.cmd&&(n=e.data),n){t.#N.process(n).forEach((e=>t.emit('message',e)))}else t.emit('message',n)}}class WebChannel{static#re='application/octet-stream';static#ie='application/json';#V=null;async init(e){const t=this;t.#V&&t.stop(),t.#V=e;const n=e.Generator,r=await t.#se(e.apiURL);await e.registerAPI(r),e.isSocketChannel||n.on('call',t.#ae.bind(t))}stop(){const e=this.#V;if(this.#V=null,e.Generator.off('call'),!e.isSocketChannel)try{fetch(e.serviceURL,{method:'delete'})}catch(e){}}async#ae(e){const t=this;let n=null;if((e=e.detail).id===t.#V.id)try{n=await t.#Z(t.#V,e),e.finish(n)}catch(t){e.finish(t)}}async#se(e){const t=this,n=t.#V,r=n.Security,i=Date.now(),s=Object.assign({},n.headers||{},{'gs-challenge':i});r.publicKey&&(s['gs-public-key']=r.publicKey);const a=await t.#ce(e,null,s,!1,'get'),c=await t.#J(a,i);return c.challenge=i.toString(),c}get#oe(){return`${WebChannel.#re}, ${WebChannel.#ie}`}#ue(e){return'string'!=typeof e?WebChannel.#re:WebChannel.#ie}async#ce(e,t,n,r,i='post'){const s=this,a=s.#V,c=s.#ue(t),o={Accept:s.#oe,'Content-Type':c,'Accept-Encoding':'gzip,deflate,br'};r&&Streams.isAvailable&&(t=Streams.toBinary(t),t=await Streams.compressOrDefault(t),o['Content-Encoding']='gzip');const u=new URL(e),l=Object.assign({},a.headers||{},o,n||{}),f=Object.assign({},a.querys||{}),y={method:i,headers:l};return t&&(y.body=t),Object.entries(f||{}).forEach((e=>{u.searchParams.append(e[0],encodeURIComponent(e[1]))})),await fetch(u.toString(),y)}async#J(e,t){let n=await WebChannel.fromResponse(e);return n instanceof Uint8Array&&(n=await Streams.unwrap(n,this.#V.Security,t)),n&&'ws'==n.type&&'data'===n.cmd?n.data:n}async#Z(e,t){const n=this,r=e.Security,i=e.serviceURL,s=r?.isValid;let a=!1,c=null;t&&(s?c=await Streams.wrap(t,n.#V.Security):(c=JSON.stringify(c),a=!0));const o={};s&&(o['gs-public-key']=r.publicKey);const u=await n.#ce(i,c,o,a),l=await n.#J(u);if('err'==l.cmd)throw new Error(l.result.msg);return l}static async fromResponse(e){if(!e.ok)throw new Error(`${e.status} : ${e.statusText}`);const t=e.headers.get('content-type')||'',n=t.includes(WebChannel.#re),r=t.includes(WebChannel.#ie),i=!n&&!r;if(r)return await e.json();if(i)return await e.text();const s=await e.arrayBuffer();return new Uint8Array(s)}}class QuarkEngine{#le=null;#fe=!1;#ye=!1;#he=!1;#pe=null;#de=null;#ge=null;#me=null;#Se=null;#we=null;#P=null;constructor(e){if(!(e=e||{}).api)throw new Error('API Url not defined!');if(!e.service)throw new Error('Service Url not defined!');const t=this;if(t.#le=null,t.#fe=!1,t.#ye=!1,t.#he=!1,t.#pe=null,t.#de=null,t.#ge=null,t.#me=null,t.#P=Date.now(),t.#le=e,t.#fe=e.api===e.service&&0==e.api.indexOf('ws'),t.#Se=e.headers||{},t.#we=e.querys||{},t.#pe=e.security instanceof Security?e.security:null,t.#ye=0===e.service.indexOf('http'),t.#he=0===e.service.indexOf('ws'),!1===(t.isWebChannel||t.isSocketChannel))throw new Error('Invalid definition for Engine Remote Service')}async init(){const e=this;if(!e.isActive)return e.#pe||(e.#pe=await Security.create()),e.#de=new Generator(e.id),(e.isWebChannel||0==e.isWSAPI)&&(e.#ge=new WebChannel,await e.WebChannel.init(e)),e.isSocketChannel&&(e.#me=new SocketChannel,await e.SocketChannel.init(e)),e}async registerAPI(e){const t=this;e.signature&&!t.Security?.isValid&&await(t.Security?.init(e)),t.Generator?.build(e.api)}stop(){const e=this;e.WebChannel?.stop(),e.SocketChannel?.stop(),e.Generator?.stop(),e.#ge=null,e.#me=null,e.#de=null,e.#pe=null,e.#le=null}get api(){return this.Generator?.api||null}get isActive(){const e=this;return!(e.SocketChannel&&!e.SocketChannel.isOpen)&&!(!e.api||!e.Security)}get apiURL(){return this.cfg?.api||null}get serviceURL(){return this.cfg?.service||null}get cfg(){return this.#le}get isWSAPI(){return this.#fe}get isWebChannel(){return this.#ye}get isSocketChannel(){return this.#he}get Security(){return this.#pe}get Generator(){return this.#de}get WebChannel(){return this.#ge}get SocketChannel(){return this.#me}get headers(){return this.#Se}get querys(){return this.#we}get id(){return this.#P}static async init(e){return new QuarkEngine(e).init()}}export{Generator,Buffer as QuarkBuffer,QuarkEngine,QuarkEvent,Queue,Request,Security,SocketChannel,Streams,WebChannel};
//# sourceMappingURL=io.greenscreens.quark.esm.min.js.map
