class QuarkError extends Error{constructor(e,t){super(e),this.data=t}static create(e){let t=e.message||e.msg||e.error||'';return e.code&&t.indexOf(e.code)<0&&(t=`${e.code} : ${t}`),new QuarkError(t,e)}}class QuarkBuffer{static#e=new TextEncoder;static#t=new TextDecoder;static validateData(e){let t=null;if(e instanceof Array)t=new Uint8Array(e);else if(e instanceof ArrayBuffer)t=new Uint8Array(e);else if(e instanceof Uint8Array)t=e;else if(e instanceof String||'string'==typeof e)t=QuarkBuffer.fromText(e);else{if(!e.toArrayBuffer)throw'Invalid input, must be String or ArrayBuffer or Uint8Array';t=new Uint8Array(e.toArrayBuffer())}return t}static isString(e){return'string'==typeof e}static isHexString(e){return!!QuarkBuffer.isString(e)&&/^[0-9A-Fa-f]+$/g.test(e)}static toBuffer(e,t=!1){const r=QuarkBuffer;return r.isString(e)&&(e=t?r.fromBase64(e):r.isHexString(e)?r.fromHex(e):r.fromText(e)),r.validateData(e)}static toText(e){return QuarkBuffer.isText(e)?e:QuarkBuffer.#t.decode(e)}static fromText(e){return QuarkBuffer.isText(e)?QuarkBuffer.#e.encode(e):e}static isText(e){return'string'==typeof e}static fromHex(e){const t=[];for(let r=0;r<e.length;r+=2)t.push(parseInt('0x'+e.substr(r,2),16));return new Uint8Array(t)}static toHex(e){return Array.prototype.map.call(new Uint8Array(e),(e=>('00'+e.toString(16)).slice(-2))).join('')}static fromBase64(e){const t=atob(e),r=new ArrayBuffer(t.length),n=new Uint8Array(r);for(let e=0,r=t.length;e<r;e++)n[e]=t.charCodeAt(e);return n}static toBase64(e){return e=QuarkBuffer.toBuffer(e),btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),''))}}class QuarkEvent extends EventTarget{#r=new Set;#n(e='',t){const r=Array.from(this.#r);return QuarkEvent.#a(t)?r.filter((r=>r.type===e&&r.listener===t)):r.filter((t=>t.type===e))}addEventListener(e,t,r){return!!QuarkEvent.#a(t)&&(this.#r.add({type:e,listener:t}),super.addEventListener(e,t,r))}removeEventListener(e,t){const r=this,n=r.#n(e,t);n.forEach((e=>super.removeEventListener(e.type,e.listener))),n.forEach((e=>r.#r.delete(e)))}unbind(){Array.from(this.#r).forEach((e=>{super.removeEventListener(e.type,e.listener)})),this.#r.clear()}on(e='',t){return this.addEventListener(e,t)}once(e,t){let wrap=e=>{t(e),wrap=null};return wrap.type=e,wrap.listener=t,this.addEventListener(e,wrap,{once:!0})}off(e='',t){return this.removeEventListener(e,t)}emit(e,t){if(!e)return!1;const r=new CustomEvent(e,{detail:t});return this.dispatchEvent(r)}send(e,t){this.emit(e,t)}listen(e,t){this.on(e,t)}unlisten(e,t){this.off(e,t)}wait(t=''){if(!t)return e('Event undefined!');const r=this;return new Promise(((e,n)=>{r.once(t,(t=>e(t)))}))}static#a(e){return'function'==typeof e}static prevent(e){QuarkEvent.#a(e,'preventDefault')&&e.preventDefault(),QuarkEvent.#a(e,'stopPropagation')&&e.stopPropagation()}static{Object.freeze(QuarkEvent)}}class QuarkStreams{static get isAvailable(){return'undefined'!=typeof CompressionStream&&'undefined'!=typeof DecompressionStream}static#i(e,t=!1,r=!1){if(!e instanceof Uint8Array)return e;const n=QuarkStreams.#s(t,r),a=new Uint8Array(8+e.length),i=new DataView(a.buffer);return i.setUint8(0,71),i.setUint8(1,83),i.setUint8(2,5),i.setUint8(3,n),i.setUint32(4,e.length),a.set(e,8),a}static async wrap(e,t){return e=QuarkStreams.toBinary(e),e=await QuarkStreams.compressOrDefault(e),e=await t.encrypt(e),e=QuarkStreams.#i(e,t.isValid,QuarkStreams.isAvailable)}static async unwrap(e,t,r){e instanceof Uint8Array&&(e=e.buffer);const n=new DataView(e),a=QuarkStreams.#u(n);if(e=Streams.toBinary(e),!a)return e;const i=n.getUint8(3),s=n.getUint32(4);if(n.byteLength!==s+8)return e;e=e.slice(8);const u=QuarkStreams.isCompressFlag(i),c=QuarkStreams.isEncryptFlag(i);let o=null;if(QuarkStreams.isApiFlag(i)){const a=n.getUint32(8),i=n.getUint32(12+a),s=n.getUint32(12+a+4+i);o={challenge:r,keyEnc:e.slice(4,4+a),keyVer:e.slice(4+a+4,4+a+4+i),signature:e.slice(4+a+4+i+4,4+a+4+i+4+s)},await t.init(o),e=e.slice(12+a+i+s)}if(c&&(e=await(t?.decrypt(e))),u&&(e=await QuarkStreams.decompress(e).arrayBuffer()),e=QuarkStreams.toBinary(e),!QuarkStreams.isJson(e))throw new Error('Invalid response');return JSON.parse(QuarkBuffer.toText(e))}static#u(e){return e.byteLength>8&&18259===e.getUint16(0)&&5===e.getUint8(2)}static isCompressFlag(e){return 1==(1&e)}static isEncryptFlag(e){return 2==(2&e)}static isApiFlag(e){return 4==(4&e)}static#s(e,t){return(t?1:0)|(e?2:0)}static#c(e,t){const r=this.toBinary(e),n=t.writable.getWriter();return n.write(r),n.close(),new Response(t.readable)}static async compressOrDefault(e,t='gzip'){if(!QuarkStreams.isAvailable)return e;const r=await QuarkStreams.compress(e,t).arrayBuffer();return Streams.toBinary(r)}static async decompressOrDefault(e,t='gzip'){if(!QuarkStreams.isAvailable)return e;const r=await QuarkStreams.decompress(e,t).arrayBuffer();return QuarkStreams.toBinary(r)}static compress(e,t='gzip'){const r=new CompressionStream(t);return this.#c(e,r)}static decompress(e,t='gzip'){const r=new DecompressionStream(t);return this.#c(e,r)}static toBinary(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):'string'==typeof e?QuarkBuffer.fromText(e):this.toBinary(JSON.stringify(e))}static isCompressed(e){return e=this.toBinary(e),this.isGzip(e)}static isGzip(e){return 31===e.at(0)&&139===e.at(1)&&8===e.at(2)}static isZlib(e){return 120===e.at(0)&&[1,94,156,218].indexOf(e.at(1))>-1}static isJson(e){const t=this,r=(e='string'==typeof e?e.trim():t.toBinary(e)).at(0),n=e.at(e.length-1);return t.#o(r,n)||t.#l(r,n)}static#l(e,t){return!('{'!==e&&123!==e||'}'!==t&&125!==t)}static#o(e,t){return!('['!==e&&91!==e||']'!==t&&93!==t)}}class QuarkSecurity{static#f={name:'ECDH',namedCurve:'P-256'};static#y={name:'ECDSA',namedCurve:'P-384'};static#h={name:'ECDSA',hash:'SHA-384'};static#p={name:'AES-CTR',length:256};static#d='gs-public-key';#k=null;#g=null;#m=null;static getRandom(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}static initKeyPair(){return crypto.subtle.generateKey(Security.#f,!0,['deriveKey','deriveBits'])}static async importKey(e,t,r){const n=QuarkBuffer.toBuffer(e,!0),a=r?r.split(','):[];return crypto.subtle.importKey('spki',n,t,!0,a)}static async exportKey(e){const t=await crypto.subtle.exportKey('raw',e);return QuarkBuffer.toHex(t)}static async verify(e,t,r){t=QuarkBuffer.toBuffer(t,!0),r=QuarkBuffer.toBuffer(r);const n=QuarkSecurity.#h;return crypto.subtle.verify(n,e,t,r)}static async sign(e,t){return t=QuarkBuffer.toBuffer(t),crypto.subtle.sign('ECDSA',e,t)}get publicKey(){return this.#k}setCookie(e,t){const r=this.isSecure?'; SameSite=None; Secure':'; SameSite=Lax';document.cookie=`${e}=${t}${r}`}cookie(e='/'){return`${QuarkSecurity.#d}=${this.cookieValue(e)}`}cookieValue(e='/'){return`${this.#k||''};path=${e}`}updateCookie(e='/'){this.setCookie(QuarkSecurity.#d,this.cookieValue(e))}#S(e){return[e.challenge||'',this.#w(e.keyEnc)||'',this.#w(e.keyVer)||''].join('')}#w(e){return QuarkBuffer.isText(e)?e:QuarkBuffer.toBase64(e)}async#Q(e){const t=QuarkSecurity.#y,r=await QuarkSecurity.importKey(e.keyVer,t,'verify');if(!await QuarkSecurity.verify(r,e.signature,this.#S(e)))throw new Error('Signature invalid')}#b(e){return QuarkSecurity.importKey(e.keyEnc,QuarkSecurity.#f,'')}#E(e,t){const r={name:'ECDH',public:t},n=QuarkSecurity.#p;return crypto.subtle.deriveKey(r,e,n,!1,['encrypt','decrypt'])}#A(e){e=QuarkBuffer.toBuffer(e);const t=Object.assign({counter:e},QuarkSecurity.#p);return t.length=128,t}async encryptRaw(e,t,r){const n=QuarkBuffer.toBuffer(r),a=this.#A(t);return crypto.subtle.encrypt(a,e,n)}async decryptRaw(e,t,r){const n=QuarkBuffer.toBuffer(r),a=this.#A(t);return crypto.subtle.decrypt(a,e,n)}async decryptAsBuffer(e,t,r){const n=await this.decryptRaw(e,t,r);return QuarkBuffer.toBuffer(n)}async encryptAsBuffer(e,t,r){const n=await this.encryptRaw(e,t,r);return QuarkBuffer.toBuffer(n)}async decryptAsString(e,t,r){const n=await this.decryptRaw(e,t,r);return QuarkBuffer.toText(n)}async encryptAsHex(e,t,r){const n=await this.encryptRaw(e,t,r);return QuarkBuffer.toHex(n)}get isValid(){return null!==this.#k&&null!==this.#m}get isSecure(){return['https:','wss:'].indexOf(location.protocol)>-1}static get isAvailable(){return!!crypto.subtle}async init(e){if(!QuarkSecurity.isAvailable)return;const t=this;await t.#Q(e);const r=await t.#b(e);t.#m=await t.#E(t.#g.privateKey,r),t.#g=null}async encrypt(e){const t=this;if(!t.isValid)return e;if(!e instanceof Uint8Array)return e;const r=QuarkSecurity.getRandom(16),n=await t.encryptAsBuffer(t.#m,r,e),a=new Uint8Array(r.length+n.length);return a.set(r,0),a.set(n,r.length),a}async decrypt(e,t){return t||(t=e.slice(0,16),e=e.slice(16)),await this.decryptAsBuffer(this.#m,t,e)}async#C(){const e=this;e.#g=await QuarkSecurity.initKeyPair(),e.#k=await QuarkSecurity.exportKey(e.#g.publicKey)}static async create(e){const t=new QuarkSecurity;return await t.#C(),e&&await t.init(e),t}}class QuarkQueue extends Map{#B=0;#v=0;#x=0;updateRequest(e){const t=this;t.#x++,t.#B++,e.tid=t.#x.toString(),t.set(e.tid,e)}reset(){const e=this;e.#B>50&&e.#v>=e.#B&&(e.#B=0,e.#v=0,e.clear())}process(e){const t=this,r=[];if(Array.isArray(e))e.forEach((e=>{const r=t.execute(e);r&&unkown.push(r)}));else{const n=t.execute(e);n&&r.push(n)}return r}execute(e){const t=this,r=e.tid;let n=null;if(t.#v++,t.has(r)){const n=t.get(r);try{n.finish(e)}catch(e){n.finish(e)}finally{t.delete(r)}}else n=e;return t.reset(),n}}class QuarkRequest{#I=0;#P=0;#R;constructor(e,t){const r=this;r.#R=t,r.#P=e,r.#U()}get(e,t){const r=this;return'timeout'===t?r.timeout:'finish'===t?r.callback.bind(r):e[t]}callback(e){const t=this;if(!t.timeout)return t.#O(),t.#R(e)}get timeout(){return!0===this.#P}#O(){0!==this.#I&&clearTimeout(this.#I)}#U(){const e=this;0!==e.#P&&(e.#I=setTimeout((()=>{e.#P=!0,e.#R(new Error('Call timeouted!'))}),e.#P))}static wrap(e,t,r){return new Proxy(e,new QuarkRequest(t,r))}}class QuarkGenerator extends QuarkEvent{#W={};#I=null;#K=0;#P=0;constructor(e=0,t=0){super(),this.#I=e,this.#P=t}get api(){return this.#W}stop(){const e=this;e.off('call'),e.off('api'),e.off('raw'),e.off('error'),e.#T()}#M(e,t){for(let r in e){let n=e[r];'object'==typeof n?this.#M(n,t)&&(e[r]=null):n._id_===t&&(e[r]=null)}return 0===Object.values(e).filter((e=>null!=e)).length}#T(){const e=this;e.#M(e.#W,e.#I),e.#W={}}build(e){const t=e?e.api||e:null;return t&&this.#D(t),t}#D(e){const t=this;Array.isArray(e)?e.forEach((e=>t.#_(e))):t.#_(e)}#_(e){const t=this;let r=null,n=null;r=t.#G(e.namespace),r[e.action]||(r[e.action]={}),n=r[e.action],t.#q(e.methods)?.forEach((e=>t.#L(n,e,t.#I)))}#q(e){return e.reduce(((e,t,r,n)=>{if(1==e.filter((e=>e.name==t.name)).length)return e;const a=n.filter((e=>e.name==t.name));if(1===a.length)return e.push(t),e;const i=a.filter((e=>e.name===t.name)).reduce(((e,t)=>(e.mid.push(t.mid),e.len.push(t.len),e.async[t.len]=t.async,e)),{name:t.name,mid:[],len:[],async:{}});return e.push(i),e}),[])}#G(e){let t=globalThis,r=this.#W;return e.split('.').every((e=>(t[e]||(t[e]={}),t=t[e],r[e]||(r[e]=t),r=t,!0))),t}#L(e,t,r){const n=!1!==t.encrypt,a={l:t.len,a:t.async||!1,x:t.mid,e:n,i:r};e[t.name]=this.#j(a),e[t.name]._id_=r}#j(e){const t=this,r=e;return function(){const e=Array.prototype.slice.call(arguments),n=Array.isArray(r.l),a=n?r.l.filter((t=>t===e.length)).pop():r.l;if(e.length!=a)throw new Error(`Invalid arguments length. Required (${r.l})`);const i=Array.isArray(r.x)?r.x[a-1]:r.x,s=n?r.a[e.length]:r.a,u=s?0:t.#P,c={handle:i,id:r.i,enc:r.e,data:e,key:++t.#K,tid:0,ts:Date.now()};return Object.seal(c),new Promise(((e,r)=>{try{const n=QuarkRequest.wrap(c,u,(n=>{t.#V(n,e,r)}));t.emit('call',n)}catch(e){r(e)}}))}}#V(e,t,r){if(e instanceof Error)return r(e);const n=e.result||e;n.success?t(n):r(QuarkError.create(n))}static build(e,t,r){const n=new QuarkGenerator(t,r);return n.build(e),n}}class QuarkSocketChannel extends QuarkEvent{#J=Date.now();#N=new QuarkQueue;#Y=null;#F=null;#$=0;async init(e){const t=this;return t.stop(),t.#F=e,new Promise(((e,r)=>(t.#H(e,r),null)))}get isOpen(){const e=this;return null!=e.#Y&&e.#Y.readyState===e.#Y.OPEN}stop(){const e=this;return null!=e.#Y&&(e.#Y.close(),e.#Y=null,e.#F=null,!0)}#z(e,t){const r={type:'GS',cmd:e,data:t?[t]:null};return JSON.stringify(r)}get#Z(){return this.#z('ping')}async#X(e){const t=this;if((e=e.detail).id!==t.#F.id)return;t.#N.updateRequest(e);const r=t.#z('data',e),n=await QuarkStreams.wrap(r,t.#F.Security);t.#Y.send(n)}async#H(e,t){const r=this,n=r.#F,a=n.Generator,i=new URL(n.serviceURL),s=Object.assign({},n.querys||{});s.q=r.#J,s.c=QuarkStreams.isAvailable,Object.entries(s||{}).forEach((e=>{e[1]&&i.searchParams.append(e[0],encodeURIComponent(e[1]))})),n.Security.updateCookie(),r.#Y=new WebSocket(i.toString(),['quark']),r.#Y.binaryType='arraybuffer';const u=r.#X.bind(r);r.#Y.onopen=i=>{if(r.emit('online',i),a.on('call',u),r.#ee(),!n.isWSAPI)return e(!0);a.once('api',(async a=>{try{const t=a.detail;t.challenge=r.#J,await n.registerAPI(t),e(!0)}catch(a){t(a)}}))},r.#Y.onclose=e=>{a.off('call',u),clearInterval(r.#$),r.stop(),r.emit('offline',e)},r.#Y.onerror=e=>{a.off('call',u),t(e),r.stop(),r.emit('error',e)},r.#Y.onmessage=async e=>{try{e.data instanceof ArrayBuffer?await r.#te(e.data):await r.#re(e.data)}catch(t){t.data=e,a.emit('error',t)}}}#ee(){const e=this;e.#$=setInterval((()=>{e.send(e.#Z)}),15e3)}async#te(e){const t=this,r=t.#F.Security;e=await QuarkStreams.unwrap(e,r,t.#J);if(!QuarkStreams.isJson(e))return generator.emit('raw',e);Array.isArray(e)?e.forEach((e=>t.#ne(e))):t.#ne(e)}async#re(e){const t=this,r=t.#F.Generator;try{if(!QuarkStreams.isJson(e))return r.emit('raw',e);e=JSON.parse(e),Array.isArray(e)?e.forEach((e=>t.#ne(e))):t.#ne(e)}catch(e){r.emit('error',e)}}async#ne(e){const t=this;let r=null;const n=t.#F.Generator;if('api'===e.cmd)return n.emit('api',e.data);if('err'===e.cmd)return n.emit('error',e.result);if('data'===e.cmd&&(r=e.data),r){t.#N.process(r).forEach((e=>t.emit('message',e)))}else t.emit('message',r)}}class QuarkWebChannel{static#ae='application/octet-stream';static#ie='application/json';#F=null;async init(e){const t=this;t.#F&&t.stop(),t.#F=e;const r=e.Generator,n=await t.#se(e.apiURL);await e.registerAPI(n),e.isSocketChannel||r.on('call',t.#ue.bind(t))}stop(){const e=this.#F;if(this.#F=null,e.Generator.off('call'),!e.isSocketChannel)try{fetch(e.serviceURL,{method:'delete'})}catch(e){}}async#ue(e){const t=this;let r=null;if((e=e.detail).id===t.#F.id)try{r=await t.#X(t.#F,e),e.finish(r)}catch(t){e.finish(t)}}async#se(e){const t=this,r=t.#F,n=r.Security,a=Date.now(),i=Object.assign({},r.headers||{},{'gs-challenge':a});n.publicKey&&(i['gs-public-key']=n.publicKey);const s=await t.#ce(e,null,i,!1,'get'),u=await t.#V(s,a);return u.challenge=a.toString(),u}get#oe(){return`${QuarkWebChannel.#ae}, ${QuarkWebChannel.#ie}`}#le(e){return'string'!=typeof e?QuarkWebChannel.#ae:QuarkWebChannel.#ie}async#ce(e,t,r,n,a='post'){const i=this,s=i.#F,u=i.#le(t),c={Accept:i.#oe,'Content-Type':u,'Accept-Encoding':'gzip,deflate,br'};n&&QuarkStreams.isAvailable&&(t=QuarkStreams.toBinary(t),t=await QuarkStreams.compressOrDefault(t),c['Content-Encoding']='gzip');const o=new URL(e),l=Object.assign({},s.headers||{},c,r||{}),f=Object.assign({},s.querys||{}),y={method:a,headers:l};return t&&(y.body=t),Object.entries(f||{}).forEach((e=>{o.searchParams.append(e[0],encodeURIComponent(e[1]))})),await fetch(o.toString(),y)}async#V(e,t){let r=await QuarkWebChannel.fromResponse(e);return r instanceof Uint8Array&&(r=await QuarkStreams.unwrap(r,this.#F.Security,t)),r&&'ws'==r.type&&'data'===r.cmd?r.data:r}async#X(e,t){const r=this,n=e.Security,a=e.serviceURL,i=n?.isValid;let s=!1,u=null;t&&(i?u=await QuarkStreams.wrap(t,r.#F.Security):(u=JSON.stringify(u),s=!0));const c={};i&&(c['gs-public-key']=n.publicKey);const o=await r.#ce(a,u,c,s),l=await r.#V(o);if('err'==l.cmd)throw new Error(l.result.msg);return l}static async fromResponse(e){if(!e.ok)throw new Error(`${e.status} : ${e.statusText}`);const t=e.headers.get('content-type')||'',r=t.includes(QuarkWebChannel.#ae),n=t.includes(QuarkWebChannel.#ie),a=!r&&!n;if(n)return await e.json();if(a)return await e.text();const i=await e.arrayBuffer();return new Uint8Array(i)}}var t=Object.freeze({__proto__:null,QuarkBuffer,QuarkEngine:class QuarkEngine{#fe=null;#ye=!1;#he=!1;#pe=!1;#de=null;#ke=null;#ge=null;#me=null;#Se=null;#we=null;#I=null;constructor(e){if(!(e=e||{}).api)throw new Error('API Url not defined!');if(!e.service)throw new Error('Service Url not defined!');const t=this;if(t.#fe=null,t.#ye=!1,t.#he=!1,t.#pe=!1,t.#de=null,t.#ke=null,t.#ge=null,t.#me=null,t.#I=Date.now(),t.#fe=e,t.#ye=e.api===e.service&&0==e.api.indexOf('ws'),t.#Se=e.headers||{},t.#we=e.querys||{},t.#de=e.security instanceof QuarkSecurity?e.security:null,t.#he=0===e.service.indexOf('http'),t.#pe=0===e.service.indexOf('ws'),!1===(t.isWebChannel||t.isSocketChannel))throw new Error('Invalid definition for Engine Remote Service')}async init(){const e=this;if(!e.isActive)return e.#de||(e.#de=await QuarkSecurity.create()),e.#ke=new QuarkGenerator(e.id),(e.isWebChannel||0==e.isWSAPI)&&(e.#ge=new QuarkWebChannel,await e.WebChannel.init(e)),e.isSocketChannel&&(e.#me=new QuarkSocketChannel,await e.SocketChannel.init(e)),e}async registerAPI(e){const t=this;e.signature&&!t.Security?.isValid&&await(t.Security?.init(e)),t.Generator?.build(e.api)}stop(){const e=this;e.WebChannel?.stop(),e.SocketChannel?.stop(),e.Generator?.stop(),e.#ge=null,e.#me=null,e.#ke=null,e.#de=null,e.#fe=null}get api(){return this.Generator?.api||null}get isActive(){const e=this;return!(e.SocketChannel&&!e.SocketChannel.isOpen)&&!(!e.api||!e.Security)}get apiURL(){return this.cfg?.api||null}get serviceURL(){return this.cfg?.service||null}get cfg(){return this.#fe}get isWSAPI(){return this.#ye}get isWebChannel(){return this.#he}get isSocketChannel(){return this.#pe}get Security(){return this.#de}get Generator(){return this.#ke}get WebChannel(){return this.#ge}get SocketChannel(){return this.#me}get headers(){return this.#Se}get querys(){return this.#we}get id(){return this.#I}static async init(e){return new QuarkEngine(e).init()}},QuarkError,QuarkEvent,QuarkGenerator,QuarkQueue,QuarkRequest,QuarkSecurity,QuarkSocketChannel,QuarkStreams,QuarkWebChannel});globalThis.QuarkEngine=t;
//# sourceMappingURL=io.greenscreens.quark.min.js.map
